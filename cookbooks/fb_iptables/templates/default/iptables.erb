### This file generated by Chef. Changes will be overwritten.
<% FB::Iptables.each_table(@ip, node) do |table, chains| %>
*<%= table %>
<%#
    Each dynamic chain needs to be created. We won't touch them, but
    they need to be created.
%>
<%   node['fb_iptables']['dynamic_chains'][table].keys.each do |chain| %>
-N <%= chain %>
<%   end %>
<%#
    Any chains the user wants that aren't in the default set also need to be
    created.
%>
<%   user_chains = chains.keys - FB::Iptables::TABLES_AND_CHAINS[table] %>
<%   user_chains.each do |chain| %>
-N <%= chain %>
<%   end %>
<%#
    Any chains that have a default policy, set it. Note that user chains
    don't get default policies
%>
<%   chains.each do |name, chain| %>
<%     if chain['policy'] %>
:<%=     name %> <%= chain['policy'] %> [0:0]
<%     end %>
<%   end %>
<%#
    Now that all the chains have been created, go ahead and populate the rules
    for them
%>
<%   chains.each do |name, chain| %>
<%     chain['rules'].each do |rule_name, rule| %>
<%       if FB::Iptables.rule_supports_ip_version?(rule, @ip) %>
# <%=      rule_name %>
<%         if rule['rules'] %>
<%           rule['rules'].each do |line| %>
-A <%=         name %> <%= line %>
<%           end %>
<%         end %>
<%         if rule['rule'] %>
-A <%=       name %> <%= rule['rule'] %>
<%         end %>
<%       end %>
<%     end %>
<%     # If any dynamic chains should be jumped to from this chain, add them %>
<%     dynamic_chains = FB::Iptables.get_dynamic_chains(table, name, node) %>
<%     next unless dynamic_chains %>
<%     dynamic_chains.each do |dynamic_chain_name| %>
-A <%=    name %> -j <%= dynamic_chain_name %>
<%     end%>
<%   end %>
COMMIT

<% end %>
#Completed
