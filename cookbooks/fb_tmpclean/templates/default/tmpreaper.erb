#!/bin/sh
PATH=/usr/sbin:/usr/bin:/sbin:/bin:/opt/local/sbin:/opt/homebrew/sbin
TMPREAPER="$(which tmpreaper)"

<%=
    FB::Utils::commentify(
      'This tmpreaper cron was generated by chef. To make' +
      ' additions, see fb_tmpclean/README.md'
    )
%>
<% tmpclean = node['fb_tmpclean'].to_hash %>

if ! [ -x "$TMPREAPER" ]; then
    exit 0
fi

if [ -s /etc/tmpreaper.conf ]; then
    . /etc/tmpreaper.conf
fi

<% tmpclean['directories'].each do |dir, time| %>
<%   excludes = [] %>
<%   tmpclean['excludes'].each do |exclude| %>
<%     excludes << "--protect '#{dir}/#{exclude}'" %>
<%   end %>
if [ -d "<%= dir %>" ]; then
  nice -n10 "$TMPREAPER" <%= excludes.join(' ') %> <%= time %> "<%= dir %>"
fi
<% end %>

<% tmpclean['extra_lines'].each do |line| %>
<%=  line %>
<% end %>
