#!/bin/sh
<% path = '/usr/sbin:/usr/bin:/sbin:/bin'
   if node.macos?
     path << ':/opt/local/sbin:/opt/facebook/sbin'
   end
   tmpclean = node['fb_tmpclean'].to_hash
   topt = tmpclean['timestamptype'] == 'atime' ? '--mtime-dir' : '--mtime' -%>

PATH=<%= path %>
TMPREAPER="$(which tmpreaper)"

<%= FB::Helpers::commentify(
      'This tmpreaper cron was generated by chef. To make' +
      ' additions, see fb_tmpclean/README.md'
    ) %>

if ! [ -x "$TMPREAPER" ]; then
    exit 0
fi

if [ -s /etc/tmpreaper.conf ]; then
    . /etc/tmpreaper.conf
fi

<% tmpclean['directories'].each do |dir, time|
     excludes = []
     tmpclean['excludes'].each do |exclude|
       excludes << "--protect '#{dir}/#{exclude}'"
     end %>
if [ -d "<%= dir %>" ]; then
  nice -n10 "$TMPREAPER" <%= topt %> <%= excludes.join(' ') %> \
    <%= time %> "<%= dir %>"
fi
<% end %>

<% tmpclean['extra_lines'].each do |line| %>
<%=  line %>
<% end %>
